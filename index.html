<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sleep Study</title>
  <link rel="manifest" href="manifest.json">
  <style>
    /* Toast styles */
    #toast-container {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 1000;
      pointer-events: none;
    }
    .toast {
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      opacity: 0;
      animation: fadein 0.3s forwards, fadeout 0.3s 2.5s forwards;
    }
    @keyframes fadein {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeout {
      from { opacity: 1; }
      to   { opacity: 0; }
    }

    /* Page styles */
    body {
      font-family: sans-serif;
      padding: 1rem;
      max-width: 400px;
      margin: auto;
      position: relative; /* for absolute children */
    }
    button {
      width: 100%;
      padding: 1rem;
      margin: 0.5rem 0;
      font-size: 1.1rem;
    }

    /* Small corner buttons */
    #export {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: auto;
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
    }

    /* Hidden clear behind gear menu */
    #settings {
      position: absolute;
      top: 1rem;
      right: 4rem;
    }
    #settings summary {
      list-style: none;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0.25rem;
    }
    #settings button {
      width: auto;
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
      margin: 0.25rem 0;
    }

    /* Separate the state log button */
    #state {
      margin-top: 2rem;
      margin-bottom: 1rem;
      border: 2px dashed #ccc;
    }
  </style>
</head>
<body>
  <h1>üõå Sleep Study</h1>

  <button id="attempt">Attempting to sleep</button>
  <button id="fail">Failed to sleep</button>
  <button id="wake">Woke Up</button>
  <button id="interrupt">Sleep Interrupted</button>

  <!-- Log energy/sleepiness separated visually -->
  <button id="state">Log Energy / Sleepiness</button>

  <!-- Export small corner button -->
  <button id="export">Export</button>

  <!-- Gear menu for settings -->
  <details id="settings">
    <summary>‚öôÔ∏è</summary>
    <button id="clear">Clear All Data</button>
  </details>

  <div id="toast-container"></div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const CYCLES_KEY = 'sleepStudyCycles';
    const ACTIVE_KEY = 'sleepStudyActive';

    function loadCycles() {
      return JSON.parse(localStorage.getItem(CYCLES_KEY) || '[]');
    }
    function saveCycles(cycles) {
      localStorage.setItem(CYCLES_KEY, JSON.stringify(cycles));
    }
    function loadActive() {
      return JSON.parse(localStorage.getItem(ACTIVE_KEY) || 'null');
    }
    function saveActive(obj) {
      if (obj === null) localStorage.removeItem(ACTIVE_KEY);
      else localStorage.setItem(ACTIVE_KEY, JSON.stringify(obj));
    }

    async function fetchWarsawTimeISO() {
      try {
        const res = await fetch('https://worldtimeapi.org/api/timezone/Europe/Warsaw');
        if (!res.ok) throw new Error();
        return (await res.json()).datetime;
      } catch {
        return new Date().toISOString();
      }
    }

    function showToast(msg) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;
      container.appendChild(toast);
      setTimeout(() => container.removeChild(toast), 3000);
    }

    async function recordAttempt() {
      const iso = await fetchWarsawTimeISO();
      const active = loadActive() || { attempts: [], failures: [] };
      active.attempts.push({ timestamp: iso });
      saveActive(active);
      showToast('Attempt logged');
    }

    async function recordFailure() {
      const iso = await fetchWarsawTimeISO();
      const active = loadActive() || { attempts: [], failures: [] };
      const batch = active.attempts.slice();
      let duration = 0;
      if (batch.length) {
        const first = new Date(batch[0].timestamp);
        duration = Math.round((new Date(iso) - first)/60000);
      }
      active.failures.push({
        failed_attempts: batch,
        failure_timestamp: iso,
        failureDurationMin: duration
      });
      active.attempts = [];
      saveActive(active);
      showToast('Failure recorded');
    }

    async function finalize(interrupted) {
      const iso = await fetchWarsawTimeISO();
      const active = loadActive();
      if (!active || !active.attempts.length) {
        showToast('No attempt to finalize');
        return;
      }
      const first = new Date(active.attempts[0].timestamp);
      const last  = new Date(active.attempts.slice(-1)[0].timestamp);
      const now   = new Date(iso);
      const attempts = active.attempts.length;
      const fallMin  = Math.round((last-first)/60000);
      const sleepMin = Math.round((now-last)/60000);
      const failCount = (active.failures||[]).length;
      const notes = prompt('Any notes for this session?','')||'';

      const cycles = loadCycles();
      const dayNum = cycles.length + 1;
      const date   = active.attempts[0].timestamp.split('T')[0];
      const label  = `Day${dayNum}, ${date}`;

      const cycle = {
        dayLabel:        label,
        failures:        active.failures||[],
        failureCount:    failCount,
        attempts:        active.attempts,
        attemptCount:    attempts,
        fallAsleepMin:   fallMin,
        wakeTimestamp:   iso,
        sleepDurationMin:sleepMin,
        notes,
        interrupted,
        evaluations:     []
      };

      cycles.push(cycle);
      saveCycles(cycles);
      saveActive(null);
      showToast('Cycle saved');
    }

    async function recordState() {
      const iso = await fetchWarsawTimeISO();
      const cycles = loadCycles();
      if (!cycles.length) {
        showToast('No session to evaluate');
        return;
      }
      const last = cycles[cycles.length -1];
      let energy     = parseInt(prompt('Energy (0‚Äì10):','5'),10);
      let sleepiness = parseInt(prompt('Sleepiness (0‚Äì10):','5'),10);
      energy     = isNaN(energy)?0:Math.min(10,Math.max(0,energy));
      sleepiness = isNaN(sleepiness)?0:Math.min(10,Math.max(0,sleepiness));
      const notes = prompt('Optional notes:','')||'';
      last.evaluations = last.evaluations||[];
      last.evaluations.push({ timestamp:iso, energy, sleepiness, notes });
      saveCycles(cycles);
      showToast('Evaluation logged');
    }

    function exportData() {
      const data = loadCycles();
      if (!data.length) {
        showToast('No data to export');
        return;
      }
      const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = `sleep-study-cycles-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Export ready');
    }

    function clearData() {
      localStorage.removeItem(CYCLES_KEY);
      localStorage.removeItem(ACTIVE_KEY);
      showToast('All data cleared');
    }

    document.getElementById('attempt').onclick   = recordAttempt;
    document.getElementById('fail').onclick      = recordFailure;
    document.getElementById('wake').onclick      = () => finalize(false);
    document.getElementById('interrupt').onclick = () => finalize(true);
    document.getElementById('state').onclick     = recordState;
    document.getElementById('export').onclick    = exportData;
    document.getElementById('clear').onclick     = clearData;
  });
  </script>
</body>
</html>
